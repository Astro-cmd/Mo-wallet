{% extends 'base.html' %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1><i class="fas fa-chart-line"></i> Financial Analytics</h1>
        <p>Visualize your financial data</p>
    </div>

    <div class="card-container">
        <!-- Financial Summary -->
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-wallet"></i> Financial Summary</h2>
            </div>
            <div class="card-body">
                <div class="summary-grid">
                    <div class="summary-card income">
                        <div class="summary-icon">
                            <i class="fas fa-arrow-down"></i>
                        </div>
                        <div class="summary-content">
                            <h3>Total Income</h3>
                            <div class="summary-value">KES {{ total_income|default:"0" }}</div>
                        </div>
                    </div>
                    
                    <div class="summary-card expense">
                        <div class="summary-icon">
                            <i class="fas fa-arrow-up"></i>
                        </div>
                        <div class="summary-content">
                            <h3>Total Expenses</h3>
                            <div class="summary-value">KES {{ total_expenses|default:"0" }}</div>
                        </div>
                    </div>
                    
                    <div class="summary-card savings">
                        <div class="summary-icon">
                            <i class="fas fa-piggy-bank"></i>
                        </div>
                        <div class="summary-content">
                            <h3>Net Savings</h3>
                            <div class="summary-value">KES {{ net_savings|default:"0" }}</div>
                        </div>
                    </div>
                    
                    <div class="summary-card ratio">
                        <div class="summary-icon">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div class="summary-content">
                            <h3>Savings Rate</h3>
                            <div class="summary-value">{{ savings_rate|default:"0" }}%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Time Period Selector -->
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-calendar-alt"></i> Time Period</h2>
            </div>
            <div class="card-body">
                <div class="time-period-selector">
                    <button class="btn btn-period active" data-period="month">This Month</button>
                    <button class="btn btn-period" data-period="quarter">This Quarter</button>
                    <button class="btn btn-period" data-period="year">This Year</button>
                    <button class="btn btn-period" data-period="all">All Time</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Income vs Expenses Chart -->
    <div class="card">
        <div class="card-header">
            <h2><i class="fas fa-balance-scale"></i> Income vs Expenses</h2>
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="incomeExpensesChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Budget Utilization -->
    <div class="card">
        <div class="card-header">
            <h2><i class="fas fa-chart-pie"></i> Budget Utilization</h2>
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="budgetChart"></canvas>
            </div>
            
            <div class="budget-details">
                {% for budget in budget_data %}
                <div class="budget-item">
                    <div class="budget-category">
                        <span class="category-color" style="background-color: {{ budget.color }};"></span>
                        <span>{{ budget.category }}</span>
                    </div>
                    <div class="budget-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ budget.percentage }}%"></div>
                        </div>
                        <div class="budget-amounts">
                            <span>KES {{ budget.spent }}</span>
                            <span>KES {{ budget.limit }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Spending by Category -->
    <div class="card">
        <div class="card-header">
            <h2><i class="fas fa-tags"></i> Spending by Category</h2>
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
$(document).ready(function() {
    // Time period selector
    $('.btn-period').click(function() {
        $('.btn-period').removeClass('active');
        $(this).addClass('active');
        const period = $(this).data('period');
        updateCharts(period);
    });

    // Income vs Expenses Chart
    const incomeExpensesCtx = document.getElementById('incomeExpensesChart').getContext('2d');
    const incomeExpensesChart = new Chart(incomeExpensesCtx, {
        type: 'bar',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            datasets: [
                {
                    label: 'Income',
                    data: [18000, 22000, 19000, 24000, 21000, 25000],
                    backgroundColor: 'rgba(16, 185, 129, 0.8)',
                    borderRadius: 6
                },
                {
                    label: 'Expenses',
                    data: [12000, 15000, 14000, 17000, 16000, 18000],
                    backgroundColor: 'rgba(239, 68, 68, 0.8)',
                    borderRadius: 6
                }
            ]
        },
        options: getChartOptions('KES')
    });

    // Budget Chart
    const budgetCtx = document.getElementById('budgetChart').getContext('2d');
    const budgetChart = new Chart(budgetCtx, {
        type: 'doughnut',
        data: {
            labels: {{ budget_labels|safe }},
            datasets: [{
                data: {{ budget_values|safe }},
                backgroundColor: {{ budget_colors|safe }},
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        color: 'white',
                        font: {
                            family: 'Poppins'
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'KES ' + context.raw.toLocaleString();
                        }
                    }
                }
            },
            cutout: '70%'
        }
    });

    // Category Chart
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    const categoryChart = new Chart(categoryCtx, {
        type: 'polarArea',
        data: {
            labels: ['Food', 'Transport', 'Housing', 'Entertainment', 'Utilities'],
            datasets: [{
                data: [4500, 3200, 5000, 1800, 2500],
                backgroundColor: [
                    'rgba(239, 68, 68, 0.7)',
                    'rgba(245, 158, 11, 0.7)',
                    'rgba(16, 185, 129, 0.7)',
                    'rgba(139, 92, 246, 0.7)',
                    'rgba(59, 130, 246, 0.7)'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        color: 'white',
                        font: {
                            family: 'Poppins'
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'KES ' + context.raw.toLocaleString();
                        }
                    }
                }
            }
        }
    });

    function updateCharts(period) {
        // In a real app, this would fetch new data from the server
        console.log('Updating charts for period:', period);
    }

    function getChartOptions(currency) {
        return {
            responsive: true,
            plugins: {
                legend: { 
                    position: 'top',
                    labels: {
                        color: 'white',
                        font: {
                            family: 'Poppins'
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    borderColor: 'rgba(255, 255, 255, 0.1)',
                    borderWidth: 1,
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            return currency + ' ' + context.raw.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                x: { 
                    grid: { 
                        display: false,
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    }
                },
                y: { 
                    grid: { 
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: { 
                        color: 'rgba(255, 255, 255, 0.7)',
                        callback: value => currency + ' ' + value
                    }
                }
            },
            animation: {
                duration: 1500,
                easing: 'easeOutQuart'
            }
        };
    }
});
</script>
{% endblock %}